{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\ndeclare global {\r\n  // allow global `var` declarations\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nexport const prisma =\r\n  globalThis.prisma ||\r\n  new PrismaClient({\r\n    log: ['query'],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== 'production') globalThis.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;;AAQO,MAAM,SACX,WAAW,MAAM,IACjB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C,WAAW,MAAM,GAAG"}},
    {"offset": {"line": 50, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/lib/data.ts"],"sourcesContent":["import { prisma } from './db';\r\nimport { Tenant, User, Post, Event, UserTenantMembership, Notification, AuditLog, Conversation, TenantRole, MembershipStatus, TenantSettings, TenantBranding } from '@prisma/client';\r\nimport bcrypt from 'bcryptjs';\r\n\r\ntype TenantWithDetails = Tenant & {\r\n    settings: TenantSettings | null;\r\n    branding: TenantBranding | null;\r\n};\r\n\r\nexport async function getTenantsForUser(userId: string): Promise<Tenant[]> {\r\n  const memberships = await prisma.userTenantMembership.findMany({\r\n    where: {\r\n      userId: userId,\r\n      status: 'APPROVED',\r\n    },\r\n    include: {\r\n      tenant: true,\r\n    },\r\n  });\r\n\r\n  return memberships.map((membership: { tenant: Tenant; }) => membership.tenant);\r\n}\r\n\r\nexport async function getTenantById(tenantId: string) {\r\n  return await prisma.tenant.findUnique({\r\n    where: { id: tenantId },\r\n    include: {\r\n      settings: true,\r\n      branding: true,\r\n    },\r\n  });\r\n}\r\n\r\nexport async function getUserById(userId: string) {\r\n  return await prisma.user.findUnique({\r\n    where: { id: userId },\r\n    include: {\r\n      profile: true,\r\n      privacySettings: true,\r\n      accountSettings: true,\r\n    },\r\n  });\r\n}\r\n\r\nexport async function getTenants(): Promise<Tenant[]> {\r\n    return await prisma.tenant.findMany({\r\n        include: {\r\n            settings: true,\r\n            branding: true,\r\n        }\r\n    });\r\n}\r\n\r\nexport async function getEventsForTenant(tenantId: string): Promise<Event[]> {\r\n  return await prisma.event.findMany({\r\n    where: { tenantId },\r\n    orderBy: { startDateTime: 'asc' },\r\n  });\r\n}\r\n\r\nexport async function getPostsForTenant(tenantId: string): Promise<Post[]> {\r\n  return await prisma.post.findMany({\r\n    where: { tenantId, isPublished: true },\r\n    orderBy: { publishedAt: 'desc' },\r\n    include: {\r\n      author: {\r\n        include: {\r\n          profile: true,\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nexport async function getMembershipForUserInTenant(userId: string, tenantId: string): Promise<UserTenantMembership | null> {\r\n  return await prisma.userTenantMembership.findUnique({\r\n    where: {\r\n      userId_tenantId: {\r\n        userId,\r\n        tenantId,\r\n      }\r\n    },\r\n  });\r\n}\r\n\r\nexport async function getNotificationsForUser(userId: string): Promise<Notification[]> {\r\n    return await prisma.notification.findMany({\r\n        where: { userId },\r\n        orderBy: { createdAt: 'desc' },\r\n    });\r\n}\r\n\r\nexport async function markNotificationAsRead(notificationId: string): Promise<Notification> {\r\n    return await prisma.notification.update({\r\n        where: { id: notificationId },\r\n        data: { isRead: true },\r\n    });\r\n}\r\n\r\nexport async function markAllNotificationsAsRead(userId: string) {\r\n    return await prisma.notification.updateMany({\r\n        where: { userId },\r\n        data: { isRead: true },\r\n    });\r\n}\r\n\r\nexport async function getUserByEmail(email: string) {\r\n    return await prisma.user.findUnique({\r\n        where: { email },\r\n        include: {\r\n            profile: true,\r\n            privacySettings: true,\r\n            accountSettings: true,\r\n        },\r\n    });\r\n}\r\n\r\nexport async function registerUser(displayName: string, email: string, pass: string) {\r\n    const existingUser = await getUserByEmail(email);\r\n    if (existingUser) {\r\n        return { success: false, message: 'User with this email already exists.' };\r\n    }\r\n    const hashedPassword = await bcrypt.hash(pass, 10);\r\n    const user = await prisma.user.create({\r\n        data: {\r\n            email,\r\n            password: hashedPassword,\r\n            profile: {\r\n                create: {\r\n                    displayName,\r\n                },\r\n            },\r\n            accountSettings: { create: {} },\r\n            privacySettings: { create: {} },\r\n        },\r\n        include: {\r\n            profile: true,\r\n            privacySettings: true,\r\n            accountSettings: true,\r\n        }\r\n    });\r\n    return { success: true, user };\r\n}\r\n\r\nexport async function createTenant(tenantDetails: Omit<Tenant, 'id' | 'slug' | 'permissions'>, ownerId: string): Promise<Tenant> {\r\n    const tenant = await prisma.tenant.create({\r\n        data: {\r\n            ...tenantDetails,\r\n            slug: tenantDetails.name.toLowerCase().replace(/ /g, '-'),\r\n            memberships: {\r\n                create: {\r\n                    userId: ownerId,\r\n                    roles: {\r\n                        create: {\r\n                            role: TenantRole.ADMIN,\r\n                        }\r\n                    },\r\n                    status: MembershipStatus.APPROVED,\r\n                }\r\n            },\r\n            settings: { \r\n                create: {\r\n                    isPublic: false,\r\n                    membershipApprovalMode: 'APPROVAL_REQUIRED',\r\n                    enableCalendar: true,\r\n                    enablePosts: true,\r\n                    enableSermons: true,\r\n                    enablePodcasts: true,\r\n                    enableBooks: true,\r\n                    enableDonations: true,\r\n                    enableVolunteering: true,\r\n                    enableSmallGroups: true,\r\n                    enableLiveStream: true,\r\n                    enablePrayerWall: true,\r\n                    enableResourceCenter: true,\r\n                    visitorVisibility: {},\r\n                    donationSettings: {},\r\n                    liveStreamSettings: {},\r\n                } \r\n            },\r\n            branding: { \r\n                create: {\r\n                    logoUrl: '',\r\n                    bannerImageUrl: '',\r\n                    primaryColor: '#000000',\r\n                    accentColor: '#FFFFFF',\r\n                    customLinks: [],\r\n                } \r\n            },\r\n        }\r\n    });\r\n    return tenant;\r\n}\r\n\r\nexport async function updateTenant(tenant: Partial<TenantWithDetails>): Promise<Tenant> {\r\n    const { id, settings, branding, ...data } = tenant;\r\n    \r\n    const updateData: any = { ...data };\r\n\r\n    if (settings) {\r\n        const { id: settingsId, tenantId: settingsTenantId, ...restOfSettings } = settings;\r\n        updateData.settings = {\r\n            update: {\r\n                ...restOfSettings,\r\n                visitorVisibility: restOfSettings.visitorVisibility || undefined,\r\n                donationSettings: restOfSettings.donationSettings || undefined,\r\n                liveStreamSettings: restOfSettings.liveStreamSettings || undefined,\r\n            }\r\n        };\r\n    }\r\n\r\n    if (branding) {\r\n        const { id: brandingId, tenantId: brandingTenantId, ...restOfBranding } = branding;\r\n        updateData.branding = {\r\n            update: {\r\n                ...restOfBranding,\r\n                customLinks: restOfBranding.customLinks || undefined,\r\n            }\r\n        };\r\n    }\r\n\r\n    return await prisma.tenant.update({\r\n        where: { id },\r\n        data: updateData,\r\n    });\r\n}\r\n\r\nexport async function requestToJoinTenant(userId: string, tenantId: string): Promise<UserTenantMembership> {\r\n    const existingMembership = await getMembershipForUserInTenant(userId, tenantId);\r\nif (existingMembership) {\r\n        return existingMembership;\r\n    }\r\n    return await prisma.userTenantMembership.create({\r\n        data: {\r\n            userId,\r\n            tenantId,\r\n            roles: {\r\n                create: {\r\n                    role: TenantRole.MEMBER,\r\n                }\r\n            },\r\n            status: MembershipStatus.PENDING,\r\n        }\r\n    });\r\n}\r\n\r\n// NOTE: These are not secure and are for demonstration only.\r\n// In a real app, you'd use secure tokens and a proper reset flow.\r\nexport async function requestPasswordReset(email: string): Promise<boolean> {\r\n    const user = await getUserByEmail(email);\r\n    if (!user) return false;\r\n    // In a real app, generate a token, save it, and email a link.\r\n    console.log(`Password reset requested for ${email}. In this demo, we'll just allow a direct reset.`);\r\n    return true;\r\n}\r\n\r\nexport async function resetPassword(email: string, newPass: string) {\r\n    const user = await getUserByEmail(email);\r\n    if (!user) return { success: false, message: \"User not found.\" };\r\n    const hashedPassword = await bcrypt.hash(newPass, 10);\r\n    await prisma.user.update({\r\n        where: { email },\r\n        data: { password: hashedPassword },\r\n    });\r\n    return { success: true };\r\n}\r\n\r\nexport async function logAuditEvent(event: Omit<AuditLog, 'id' | 'createdAt'>): Promise<AuditLog> {\r\n    return await prisma.auditLog.create({\r\n        data: {\r\n            ...event,\r\n            metadata: event.metadata || {},\r\n        },\r\n    });\r\n}\r\n\r\nexport async function getOrCreateDirectConversation(userId1: string, userId2: string): Promise<Conversation> {\r\n    const existing = await prisma.conversation.findFirst({\r\n        where: {\r\n            isDirectMessage: true,\r\n            participants: {\r\n                every: {\r\n                    userId: { in: [userId1, userId2] }\r\n                }\r\n            }\r\n        },\r\n        include: { participants: true }\r\n    });\r\n\r\n    if (existing) return existing;\r\n\r\n    return await prisma.conversation.create({\r\n        data: {\r\n            isDirectMessage: true,\r\n            participants: {\r\n                create: [\r\n                    { userId: userId1 },\r\n                    { userId: userId2 },\r\n                ]\r\n            }\r\n        }\r\n    });\r\n}\r\n\r\nexport async function getConversationsForUser(userId: string) {\r\n    return await prisma.conversation.findMany({\r\n        where: {\r\n            participants: {\r\n                some: {\r\n                    userId: userId\r\n                }\r\n            }\r\n        },\r\n        include: {\r\n            participants: {\r\n                include: {\r\n                    user: {\r\n                        include: {\r\n                            profile: true\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            messages: {\r\n                orderBy: {\r\n                    createdAt: 'desc'\r\n                },\r\n                take: 1,\r\n                include: {\r\n                    user: {\r\n                        include: {\r\n                            profile: true\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        orderBy: {\r\n            id: 'desc'\r\n        }\r\n    });\r\n}\r\n\r\nexport async function getMessagesForConversation(conversationId: string) {\r\n    return await prisma.chatMessage.findMany({\r\n        where: {\r\n            conversationId: conversationId\r\n        },\r\n        include: {\r\n            user: {\r\n                include: {\r\n                    profile: true\r\n                }\r\n            }\r\n        },\r\n        orderBy: {\r\n            createdAt: 'asc'\r\n        }\r\n    });\r\n}\r\n\r\nexport async function addMessage(conversationId: string, senderId: string, content: string) {\r\n    const message = await prisma.chatMessage.create({\r\n        data: {\r\n            conversationId,\r\n            userId: senderId,\r\n            text: content\r\n        },\r\n        include: {\r\n            user: {\r\n                include: {\r\n                    profile: true\r\n                }\r\n            }\r\n        }\r\n    });\r\n\r\n    return message;\r\n}\r\n\r\nexport async function deleteMessage(messageId: string) {\r\n    return await prisma.chatMessage.delete({\r\n        where: { id: messageId }\r\n    });\r\n}\r\n\r\nexport async function markConversationAsRead(conversationId: string, userId: string) {\r\n    // This would update read receipts via ConversationParticipant's lastReadMessageId\r\n    // For now, just return success\r\n    return { success: true };\r\n}\r\n\r\nexport async function getAllUsers() {\r\n    return await prisma.user.findMany({\r\n        include: {\r\n            profile: true\r\n        }\r\n    });\r\n}\r\n\r\nexport async function getAuditLogs() {\r\n    return await prisma.auditLog.findMany({\r\n        include: {\r\n            actorUser: {\r\n                include: {\r\n                    profile: true\r\n                }\r\n            },\r\n            effectiveUser: {\r\n                include: {\r\n                    profile: true\r\n                }\r\n            }\r\n        },\r\n        orderBy: {\r\n            createdAt: 'desc'\r\n        },\r\n        take: 100\r\n    });\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 555, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/ui/Input.tsx"],"sourcesContent":["import React from 'react';\r\n\r\ninterface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {\r\n  label: string;\r\n  containerClassName?: string;\r\n}\r\n\r\nconst Input: React.FC<InputProps> = ({ label, id, containerClassName, ...props }) => {\r\n  return (\r\n    <div className={containerClassName}>\r\n      <label htmlFor={id} className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n        {label}\r\n      </label>\r\n      <input\r\n        id={id}\r\n        className=\"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white text-gray-900 placeholder:text-gray-400\"\r\n        {...props}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Input;"],"names":[],"mappings":";;;;;;AAOA,MAAM,QAA8B,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,kBAAkB,EAAE,GAAG,OAAO;IAC9E,qBACE,8OAAC;QAAI,WAAW;;0BACd,8OAAC;gBAAM,SAAS;gBAAI,WAAU;0BAC3B;;;;;;0BAEH,8OAAC;gBACC,IAAI;gBACJ,WAAU;gBACT,GAAG,KAAK;;;;;;;;;;;;AAIjB;uCAEe"}},
    {"offset": {"line": 595, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/messages/ConversationList.tsx"],"sourcesContent":["import React, { useMemo } from 'react';\r\nimport type { EnrichedConversation, User } from '../../types';\r\nimport Input from '../ui/Input';\r\n\r\ninterface ConversationListProps {\r\n  conversations: EnrichedConversation[];\r\n  currentUser: User;\r\n  activeConversationId?: string | null;\r\n  onConversationSelect: (conversation: EnrichedConversation) => void;\r\n  searchTerm?: string;\r\n  onSearchChange?: (term: string) => void;\r\n}\r\n\r\nconst ConversationList: React.FC<ConversationListProps> = ({\r\n  conversations,\r\n  currentUser,\r\n  activeConversationId,\r\n  onConversationSelect,\r\n  searchTerm,\r\n  onSearchChange,\r\n}) => {\r\n  const getOtherParticipant = (conv: EnrichedConversation) => {\r\n    return conv.participants.find((p) => p.id !== currentUser.id);\r\n  };\r\n\r\n  const filteredConversations = useMemo(() => {\r\n    if (!searchTerm) return conversations;\r\n    const lowercasedTerm = searchTerm.toLowerCase();\r\n    return conversations.filter((c) => c.displayName.toLowerCase().includes(lowercasedTerm));\r\n  }, [conversations, searchTerm]);\r\n\r\n  return (\r\n    <div className=\"flex-1 flex flex-col\">\r\n      {onSearchChange && searchTerm !== undefined && (\r\n        <div className=\"p-4 border-b border-gray-200\">\r\n          <Input\r\n            label=\"\"\r\n            id=\"conversation-search\"\r\n            type=\"search\"\r\n            placeholder=\"Search conversations...\"\r\n            value={searchTerm}\r\n            onChange={(e) => onSearchChange(e.target.value)}\r\n          />\r\n        </div>\r\n      )}\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        <ul className=\"divide-y divide-gray-200\">\r\n          {filteredConversations.map((conv) => {\r\n            const otherParticipant = conv.isDirect ? getOtherParticipant(conv) : null;\r\n            const isActive = conv.id === activeConversationId;\r\n            const lastMessageText = conv.lastMessage\r\n              ? `${conv.lastMessage.userId === currentUser.id ? 'You: ' : ''}${conv.lastMessage.text}`\r\n              : 'No messages yet';\r\n\r\n            return (\r\n              <li\r\n                key={conv.id}\r\n                onClick={() => onConversationSelect(conv)}\r\n                className={`p-4 cursor-pointer transition-colors ${\r\n                  isActive ? 'bg-amber-50' : 'hover:bg-gray-50'\r\n                }`}\r\n              >\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <div className=\"relative\">\r\n                    {conv.isDirect && otherParticipant ? (\r\n                      <img\r\n                        className=\"h-10 w-10 rounded-full\"\r\n                        // FIX: Access avatarUrl and displayName from the nested profile object.\r\n                        src={otherParticipant.profile.avatarUrl}\r\n                        alt={otherParticipant.profile.displayName}\r\n                      />\r\n                    ) : (\r\n                      <div className=\"h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center\">\r\n                        <span className=\"text-gray-500 font-bold\">#</span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <div className=\"flex justify-between items-center\">\r\n                      <p className=\"text-sm font-semibold text-gray-900 truncate\">\r\n                        {conv.displayName}\r\n                      </p>\r\n                      {conv.lastMessage && (\r\n                        <div className=\"text-xs text-gray-400 self-start flex-shrink-0 ml-2\">\r\n                          {conv.lastMessage.createdAt.toLocaleTimeString([], {\r\n                            hour: '2-digit',\r\n                            minute: '2-digit',\r\n                          })}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex justify-between items-center\">\r\n                       <p className=\"text-sm text-gray-500 truncate\">{lastMessageText}</p>\r\n                       {conv.unreadCount > 0 && (\r\n                         <span className=\"ml-2 flex-shrink-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-500 rounded-full\">\r\n                           {conv.unreadCount}\r\n                         </span>\r\n                       )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </li>\r\n            );\r\n          })}\r\n        </ul>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ConversationList;\r\n"],"names":[],"mappings":";;;;;AAAA;AAEA;;;;AAWA,MAAM,mBAAoD,CAAC,EACzD,aAAa,EACb,WAAW,EACX,oBAAoB,EACpB,oBAAoB,EACpB,UAAU,EACV,cAAc,EACf;IACC,MAAM,sBAAsB,CAAC;QAC3B,OAAO,KAAK,YAAY,CAAC,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,YAAY,EAAE;IAC9D;IAEA,MAAM,wBAAwB,IAAA,gNAAO,EAAC;QACpC,IAAI,CAAC,YAAY,OAAO;QACxB,MAAM,iBAAiB,WAAW,WAAW;QAC7C,OAAO,cAAc,MAAM,CAAC,CAAC,IAAM,EAAE,WAAW,CAAC,WAAW,GAAG,QAAQ,CAAC;IAC1E,GAAG;QAAC;QAAe;KAAW;IAE9B,qBACE,8OAAC;QAAI,WAAU;;YACZ,kBAAkB,eAAe,2BAChC,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC,4IAAK;oBACJ,OAAM;oBACN,IAAG;oBACH,MAAK;oBACL,aAAY;oBACZ,OAAO;oBACP,UAAU,CAAC,IAAM,eAAe,EAAE,MAAM,CAAC,KAAK;;;;;;;;;;;0BAIpD,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC;oBAAG,WAAU;8BACX,sBAAsB,GAAG,CAAC,CAAC;wBAC1B,MAAM,mBAAmB,KAAK,QAAQ,GAAG,oBAAoB,QAAQ;wBACrE,MAAM,WAAW,KAAK,EAAE,KAAK;wBAC7B,MAAM,kBAAkB,KAAK,WAAW,GACpC,GAAG,KAAK,WAAW,CAAC,MAAM,KAAK,YAAY,EAAE,GAAG,UAAU,KAAK,KAAK,WAAW,CAAC,IAAI,EAAE,GACtF;wBAEJ,qBACE,8OAAC;4BAEC,SAAS,IAAM,qBAAqB;4BACpC,WAAW,CAAC,qCAAqC,EAC/C,WAAW,gBAAgB,oBAC3B;sCAEF,cAAA,8OAAC;gCAAI,WAAU;;kDACb,8OAAC;wCAAI,WAAU;kDACZ,KAAK,QAAQ,IAAI,iCAChB,8OAAC;4CACC,WAAU;4CACV,wEAAwE;4CACxE,KAAK,iBAAiB,OAAO,CAAC,SAAS;4CACvC,KAAK,iBAAiB,OAAO,CAAC,WAAW;;;;;qGAG3C,8OAAC;4CAAI,WAAU;sDACb,cAAA,8OAAC;gDAAK,WAAU;0DAA0B;;;;;;;;;;;;;;;;kDAIhD,8OAAC;wCAAI,WAAU;;0DACb,8OAAC;gDAAI,WAAU;;kEACb,8OAAC;wDAAE,WAAU;kEACV,KAAK,WAAW;;;;;;oDAElB,KAAK,WAAW,kBACf,8OAAC;wDAAI,WAAU;kEACZ,KAAK,WAAW,CAAC,SAAS,CAAC,kBAAkB,CAAC,EAAE,EAAE;4DACjD,MAAM;4DACN,QAAQ;wDACV;;;;;;;;;;;;0DAIN,8OAAC;gDAAI,WAAU;;kEACZ,8OAAC;wDAAE,WAAU;kEAAkC;;;;;;oDAC9C,KAAK,WAAW,GAAG,mBAClB,8OAAC;wDAAK,WAAU;kEACb,KAAK,WAAW;;;;;;;;;;;;;;;;;;;;;;;;2BAvCvB,KAAK,EAAE;;;;;oBA+ClB;;;;;;;;;;;;;;;;;AAKV;uCAEe"}},
    {"offset": {"line": 780, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/ui/Button.tsx"],"sourcesContent":["import React from 'react';\r\n\r\ninterface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {\r\n  variant?: 'primary' | 'secondary' | 'danger';\r\n  size?: 'sm' | 'md';\r\n  children: React.ReactNode;\r\n}\r\n\r\nconst Button: React.FC<ButtonProps> = ({ children, variant = 'primary', size = 'md', className, ...props }) => {\r\n  const baseClasses = \"rounded-md font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\";\r\n\r\n  const variantClasses = {\r\n    primary: 'bg-amber-600 text-white hover:bg-amber-700 focus:ring-amber-500',\r\n    secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',\r\n    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',\r\n  };\r\n  \r\n  const sizeClasses = {\r\n      md: \"px-4 py-2 text-sm\",\r\n      sm: \"px-3 py-1.5 text-xs\",\r\n  }\r\n\r\n  return (\r\n    <button className={`${baseClasses} ${variantClasses[variant]} ${sizeClasses[size]} ${className}`} {...props}>\r\n      {children}\r\n    </button>\r\n  );\r\n};\r\n\r\nexport default Button;\r\n"],"names":[],"mappings":";;;;;;AAQA,MAAM,SAAgC,CAAC,EAAE,QAAQ,EAAE,UAAU,SAAS,EAAE,OAAO,IAAI,EAAE,SAAS,EAAE,GAAG,OAAO;IACxG,MAAM,cAAc;IAEpB,MAAM,iBAAiB;QACrB,SAAS;QACT,WAAW;QACX,QAAQ;IACV;IAEA,MAAM,cAAc;QAChB,IAAI;QACJ,IAAI;IACR;IAEA,qBACE,8OAAC;QAAO,WAAW,GAAG,YAAY,CAAC,EAAE,cAAc,CAAC,QAAQ,CAAC,CAAC,EAAE,WAAW,CAAC,KAAK,CAAC,CAAC,EAAE,WAAW;QAAG,GAAG,KAAK;kBACxG;;;;;;AAGP;uCAEe"}},
    {"offset": {"line": 812, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/lib/permissions.ts"],"sourcesContent":["import { TenantRole, User, Tenant, ChatMessage, Conversation, UserTenantMembership } from '@prisma/client';\r\nimport { prisma } from './db';\r\n\r\n// Define RolePermissions based on your application's logic, as it's not in Prisma schema\r\nexport interface RolePermissions {\r\n  canCreatePosts: boolean;\r\n  canCreateEvents: boolean;\r\n  canCreateSermons: boolean;\r\n  canCreatePodcasts: boolean;\r\n  canCreateBooks: boolean;\r\n  canCreateGroupChats: boolean;\r\n  canInviteMembers: boolean;\r\n  canApproveMembership: boolean;\r\n  canBanMembers: boolean;\r\n  canModeratePosts: boolean;\r\n  canModerateChats: boolean;\r\n  canPostInAnnouncementChannels?: boolean;\r\n  canManagePrayerWall: boolean;\r\n  canUploadResources: boolean;\r\n  canManageResources: boolean;\r\n  canManageContactSubmissions: boolean;\r\n}\r\n\r\n// This can be a simple enum if you don't need the string values\r\nexport enum TenantRoleType {\r\n    MEMBER = 'MEMBER',\r\n    STAFF = 'STAFF',\r\n    MODERATOR = 'MODERATOR',\r\n}\r\n\r\nasync function getMembershipForUserInTenant(userId: string, tenantId: string): Promise<(UserTenantMembership & { roles: { role: TenantRole }[] }) | null> {\r\n    return prisma.userTenantMembership.findUnique({\r\n        where: {\r\n            userId_tenantId: {\r\n                userId,\r\n                tenantId,\r\n            },\r\n        },\r\n        include: {\r\n            roles: {\r\n                select: {\r\n                    role: true\r\n                }\r\n            },\r\n        }\r\n    });\r\n}\r\n\r\n\r\n\r\n/**\r\n * Maps a specific TenantRole to a more general TenantRoleType for permission lookups.\r\n */\r\nfunction getRoleType(role: TenantRole): TenantRoleType | 'ADMIN' {\r\n    switch (role) {\r\n        case TenantRole.ADMIN:\r\n            return 'ADMIN';\r\n        case TenantRole.STAFF:\r\n        case TenantRole.CLERGY:\r\n            return TenantRoleType.STAFF;\r\n        case TenantRole.MODERATOR:\r\n            return TenantRoleType.MODERATOR;\r\n        case TenantRole.MEMBER:\r\n            return TenantRoleType.MEMBER;\r\n        default:\r\n            return TenantRoleType.MEMBER;\r\n    }\r\n}\r\n\r\n\r\n/**\r\n * Checks if a user has a specific permission within a tenant.\r\n * This is the centralized source of truth for all permission checks.\r\n *\r\n * @param user The user to check.\r\n * @param tenant The tenant context for the permission.\r\n * @param permission The permission to check for (e.g., 'canCreatePosts').\r\n * @returns {boolean} True if the user has the permission, false otherwise.\r\n */\r\nexport async function can(user: User, tenant: Tenant, permission: keyof RolePermissions): Promise<boolean> {\r\n  // Super Admins can do anything.\r\n  if (user.isSuperAdmin) {\r\n    return true;\r\n  }\r\n\r\n  // Find the user's membership for this specific tenant.\r\n  const membership = await getMembershipForUserInTenant(user.id, tenant.id);\r\n\r\n  // If the user is not a member or not approved, they have no permissions.\r\n  if (!membership || membership.status !== 'APPROVED') {\r\n    return false;\r\n  }\r\n  \r\n  // Check if any of the user's roles grant the required permission.\r\n  for (const roleInfo of membership.roles) {\r\n    const roleType = getRoleType(roleInfo.role);\r\n    const permissions = tenant.permissions as any;\r\n\r\n    if (roleType === 'ADMIN') {\r\n        // Admins have all permissions defined under the ADMIN key.\r\n        if (permissions.ADMIN[permission]) {\r\n            return true;\r\n        }\r\n    } else {\r\n        // For other roles, check against their TenantRoleType.\r\n        const rolePerms = permissions[roleType];\r\n        if (rolePerms && rolePerms[permission]) {\r\n            return true; // Permission granted by at least one role.\r\n        }\r\n    }\r\n  }\r\n\r\n  return false; // No role granted the permission.\r\n}\r\n\r\n/**\r\n * Checks if a user has a specific role within a tenant.\r\n *\r\n * @param user The user to check.\r\n * @param tenantId The ID of the tenant context for the role.\r\n * @param role The role to check for.\r\n * @returns {boolean} True if the user has the role, false otherwise.\r\n */\r\nexport async function hasRole(userId: string, tenantId: string, requiredRoles: TenantRole[]): Promise<boolean> {\r\n  const membership = await getMembershipForUserInTenant(userId, tenantId);\r\n\r\n  if (!membership || membership.status !== 'APPROVED') {\r\n    return false;\r\n  }\r\n\r\n  return membership.roles.some(roleInfo => requiredRoles.includes(roleInfo.role));\r\n}\r\n\r\n/**\r\n * Checks if a user can view a certain type of content (e.g., posts, events).\r\n * It checks tenant settings for public visibility and feature enablement.\r\n *\r\n * @param userId The ID of the user attempting to view. Can be null for anonymous users.\r\n * @param tenantId The ID of the tenant where the content resides.\r\n * @param contentType The key for the content type in tenant settings (e.g., 'posts', 'calendar').\r\n * @returns {Promise<boolean>} True if the user can view the content.\r\n */\r\nexport async function canUserViewContent(userId: string | null, tenantId: string, contentType: 'posts' | 'calendar' | 'sermons' | 'podcasts' | 'books' | 'prayerWall'): Promise<boolean> {\r\n    const tenant = await prisma.tenant.findUnique({\r\n        where: { id: tenantId },\r\n        include: { settings: true }\r\n    });\r\n\r\n    if (!tenant || !tenant.settings) return false;\r\n\r\n    const settings = tenant.settings as any;\r\n\r\n    // Check if the entire feature is disabled\r\n    const featureFlag = `enable${contentType.charAt(0).toUpperCase() + contentType.slice(1)}`;\r\n    if (!settings[featureFlag]) {\r\n        return false;\r\n    }\r\n\r\n    const membership = userId ? await getMembershipForUserInTenant(userId, tenantId) : null;\r\n\r\n    // If user is not a member, check public visibility settings\r\n    if (!membership || membership.status !== 'APPROVED') {\r\n        return settings.visitorVisibility[contentType];\r\n    }\r\n\r\n    // If they are an approved member, they can view it as long as the feature is enabled.\r\n    return true;\r\n}\r\n\r\n/**\r\n * Checks if a user has permission to create a post in a tenant.\r\n *\r\n * @param userId The ID of the user.\r\n * @param tenantId The ID of the tenant.\r\n * @param isAnnouncement Whether the post is an announcement.\r\n * @returns {Promise<boolean>} True if the user can create the post.\r\n */\r\nexport async function canUserPost(userId: string, tenantId: string, isAnnouncement: boolean): Promise<boolean> {\r\n    const user = await prisma.user.findUnique({ where: { id: userId } });\r\n    const tenant = await prisma.tenant.findUnique({ where: { id: tenantId }, include: { permissions: true } });\r\n\r\n    if (!user || !tenant) return false;\r\n\r\n    if (isAnnouncement) {\r\n        return can(user, tenant, 'canPostInAnnouncementChannels');\r\n    }\r\n    return can(user, tenant, 'canCreatePosts');\r\n}\r\n\r\n\r\n/**\r\n * Checks if a user can delete a specific message.\r\n */\r\nexport async function canDeleteMessage(\r\n  user: User,\r\n  message: ChatMessage,\r\n  conversation: Conversation,\r\n  tenant: Tenant\r\n): Promise<boolean> {\r\n  if (user.isSuperAdmin) {\r\n    return true;\r\n  }\r\n  // User can delete their own message\r\n  if (message.userId === user.id) {\r\n    return true;\r\n  }\r\n  // Check for moderation permissions\r\n  if (!conversation.isDirectMessage) { // isGroupChat\r\n    if (await can(user, tenant, 'canModerateChats')) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 971, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/messages/MessageStream.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useState, useRef, useEffect, useMemo, useCallback } from 'react';\r\nimport type { User, EnrichedConversation, EnrichedChatMessage, Tenant } from '../../types';\r\nimport { getMessagesForConversation, addMessage, markConversationAsRead, deleteMessage } from '../../../lib/data';\r\nimport Button from '../ui/Button';\r\nimport { can, canDeleteMessage } from '../../../lib/permissions';\r\n\r\ninterface MessageStreamProps {\r\n  currentUser: User;\r\n  conversation: EnrichedConversation;\r\n  onViewProfile: (userId: string) => void;\r\n  tenant?: Tenant;\r\n  isDetailsPanelOpen: boolean;\r\n  onToggleDetailsPanel: () => void;\r\n  onMarkAsRead: () => void;\r\n}\r\n\r\nconst MessageStream: React.FC<MessageStreamProps> = ({ currentUser, conversation, onViewProfile, tenant, isDetailsPanelOpen, onToggleDetailsPanel, onMarkAsRead }) => {\r\n  const [messages, setMessages] = useState<EnrichedChatMessage[]>(() =>\r\n    getMessagesForConversation(conversation.id, tenant?.id)\r\n  );\r\n  const [newMessage, setNewMessage] = useState('');\r\n  const [showActionsFor, setShowActionsFor] = useState<string | null>(null);\r\n  const messagesEndRef = useRef<HTMLDivElement | null>(null);\r\n\r\n  const scrollToBottom = () => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n  };\r\n\r\n  useEffect(() => {\r\n    setMessages(getMessagesForConversation(conversation.id, tenant?.id));\r\n    markConversationAsRead(currentUser.id, conversation.id);\r\n    onMarkAsRead();\r\n  }, [conversation.id, currentUser.id, onMarkAsRead, tenant?.id]);\r\n  \r\n  useEffect(() => {\r\n    scrollToBottom();\r\n  }, [messages]);\r\n  \r\n  const canSendMessage = useMemo(() => {\r\n    if (conversation.isDirect) {\r\n      return true;\r\n    }\r\n    if (tenant && conversation.name?.toLowerCase() === '#announcements') {\r\n      return can(currentUser, tenant, 'canPostInAnnouncementChannels');\r\n    }\r\n    return true;\r\n  }, [currentUser, conversation, tenant]);\r\n\r\n  const handleSendMessage = (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (newMessage.trim() === '' || !canSendMessage) return;\r\n    addMessage(conversation.id, currentUser.id, newMessage.trim());\r\n    setMessages(getMessagesForConversation(conversation.id, tenant?.id));\r\n    setNewMessage('');\r\n    onMarkAsRead();\r\n  };\r\n  \r\n  const handleDeleteMessage = useCallback((messageId: string) => {\r\n    const success = deleteMessage(messageId, currentUser.id);\r\n    if (success) {\r\n      setMessages(currentMessages => currentMessages.filter(m => m.id !== messageId));\r\n      onMarkAsRead(); // To update last message snippet\r\n    } else {\r\n      alert(\"You don't have permission to delete this message.\");\r\n    }\r\n  }, [currentUser.id, onMarkAsRead]);\r\n\r\n  const otherParticipant = conversation.isDirect ? conversation.participants.find(p => p.id !== currentUser.id) : null;\r\n\r\n  return (\r\n    <>\r\n      {/* Header */}\r\n      <div className=\"p-4 border-b border-gray-200 flex items-center justify-between\">\r\n         <div className=\"flex items-center space-x-3\">\r\n             {conversation.isDirect && otherParticipant ? (\r\n                // FIX: Access avatarUrl and displayName from the nested profile object.\r\n                <img src={otherParticipant.profile.avatarUrl} alt={otherParticipant.profile.displayName} className=\"w-10 h-10 rounded-full\" />\r\n             ) : (\r\n                <div className=\"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500 text-xl\">#</div>\r\n             )}\r\n             <div>\r\n                <h2 className=\"text-lg font-bold text-gray-900\">{conversation.displayName}</h2>\r\n             </div>\r\n         </div>\r\n         {!conversation.isDirect && (\r\n            <button onClick={onToggleDetailsPanel} className={`p-2 rounded-md transition-colors lg:hidden ${isDetailsPanelOpen ? 'bg-amber-100 text-amber-700' : 'text-gray-400 hover:bg-gray-100 hover:text-gray-600'}`}>\r\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-6 w-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\" />\r\n                </svg>\r\n            </button>\r\n         )}\r\n      </div>\r\n\r\n      {/* Messages Area */}\r\n      <div className=\"flex-1 p-6 overflow-y-auto space-y-2\">\r\n        {messages.map((msg) => {\r\n           const userCanDelete = canDeleteMessage(currentUser, msg, conversation, tenant);\r\n           const isOwnMessage = msg.userId === currentUser.id;\r\n           return (\r\n            <div\r\n              key={msg.id}\r\n              className={`flex items-start gap-3 group relative ${\r\n                isOwnMessage ? 'justify-end' : 'justify-start'\r\n              }`}\r\n              onMouseEnter={() => setShowActionsFor(msg.id)}\r\n              onMouseLeave={() => setShowActionsFor(null)}\r\n            >\r\n              {!isOwnMessage && (\r\n                <img\r\n                  src={msg.userAvatarUrl}\r\n                  alt={msg.userDisplayName}\r\n                  className=\"w-8 h-8 rounded-full cursor-pointer\"\r\n                  onClick={() => onViewProfile(msg.userId)}\r\n                />\r\n              )}\r\n              <div className=\"flex flex-col\">\r\n                <div\r\n                  className={`max-w-md p-3 rounded-lg ${\r\n                    isOwnMessage ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-800'\r\n                  }`}\r\n                >\r\n                  {!isOwnMessage && (\r\n                    <p \r\n                        className=\"text-xs font-bold mb-1 text-amber-700 cursor-pointer\"\r\n                        onClick={() => onViewProfile(msg.userId)}\r\n                    >\r\n                        {msg.userDisplayName}\r\n                    </p>\r\n                  )}\r\n                  <p className=\"text-sm\" style={{ whiteSpace: 'pre-wrap' }}>{msg.text}</p>\r\n                </div>\r\n                <p className={`text-xs mt-1 ${isOwnMessage ? 'text-gray-400 self-end' : 'text-gray-400'}`}>\r\n                  {msg.createdAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\r\n                </p>\r\n              </div>\r\n              {showActionsFor === msg.id && userCanDelete && (\r\n                <div className={`absolute top-0 ${isOwnMessage ? 'left-0 -translate-x-full pr-2' : 'right-0 translate-x-full pl-2'}`}>\r\n                  <div className=\"bg-white rounded-md shadow-lg border border-gray-200\">\r\n                    <button\r\n                      onClick={() => handleDeleteMessage(msg.id)}\r\n                      className=\"flex items-center space-x-2 w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50\"\r\n                    >\r\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\r\n                        <path fillRule=\"evenodd\" d=\"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z\" clipRule=\"evenodd\" />\r\n                      </svg>\r\n                      <span>Delete</span>\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n           );\r\n        })}\r\n        <div ref={messagesEndRef} />\r\n      </div>\r\n\r\n      {/* Input Area */}\r\n      <div className=\"p-4 border-t border-gray-200 bg-gray-50\">\r\n        {canSendMessage ? (\r\n          <form onSubmit={handleSendMessage} className=\"flex items-center space-x-4\">\r\n            <input\r\n              type=\"text\"\r\n              placeholder={`Message ${conversation.displayName}...`}\r\n              aria-label=\"Chat message input\"\r\n              value={newMessage}\r\n              onChange={(e) => setNewMessage(e.target.value)}\r\n              className=\"flex-1 w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-white text-gray-900 placeholder:text-gray-400\"\r\n            />\r\n            <Button type=\"submit\">Send</Button>\r\n          </form>\r\n        ) : (\r\n            <div className=\"text-center text-sm text-gray-500 italic px-4 py-2 bg-gray-100 rounded-full\">\r\n                You do not have permission to post in this channel.\r\n            </div>\r\n        )}\r\n      </div>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default MessageStream;"],"names":[],"mappings":";;;;;AAEA;AAEA;AACA;AACA;AANA;;;;;;AAkBA,MAAM,gBAA8C,CAAC,EAAE,WAAW,EAAE,YAAY,EAAE,aAAa,EAAE,MAAM,EAAE,kBAAkB,EAAE,oBAAoB,EAAE,YAAY,EAAE;IAC/J,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAwB,IAC9D,IAAA,yIAA0B,EAAC,aAAa,EAAE,EAAE,QAAQ;IAEtD,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAC7C,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAgB;IACpE,MAAM,iBAAiB,IAAA,+MAAM,EAAwB;IAErD,MAAM,iBAAiB;QACrB,eAAe,OAAO,EAAE,eAAe;YAAE,UAAU;QAAS;IAC9D;IAEA,IAAA,kNAAS,EAAC;QACR,YAAY,IAAA,yIAA0B,EAAC,aAAa,EAAE,EAAE,QAAQ;QAChE,IAAA,qIAAsB,EAAC,YAAY,EAAE,EAAE,aAAa,EAAE;QACtD;IACF,GAAG;QAAC,aAAa,EAAE;QAAE,YAAY,EAAE;QAAE;QAAc,QAAQ;KAAG;IAE9D,IAAA,kNAAS,EAAC;QACR;IACF,GAAG;QAAC;KAAS;IAEb,MAAM,iBAAiB,IAAA,gNAAO,EAAC;QAC7B,IAAI,aAAa,QAAQ,EAAE;YACzB,OAAO;QACT;QACA,IAAI,UAAU,aAAa,IAAI,EAAE,kBAAkB,kBAAkB;YACnE,OAAO,IAAA,yHAAG,EAAC,aAAa,QAAQ;QAClC;QACA,OAAO;IACT,GAAG;QAAC;QAAa;QAAc;KAAO;IAEtC,MAAM,oBAAoB,CAAC;QACzB,EAAE,cAAc;QAChB,IAAI,WAAW,IAAI,OAAO,MAAM,CAAC,gBAAgB;QACjD,IAAA,yHAAU,EAAC,aAAa,EAAE,EAAE,YAAY,EAAE,EAAE,WAAW,IAAI;QAC3D,YAAY,IAAA,yIAA0B,EAAC,aAAa,EAAE,EAAE,QAAQ;QAChE,cAAc;QACd;IACF;IAEA,MAAM,sBAAsB,IAAA,oNAAW,EAAC,CAAC;QACvC,MAAM,UAAU,IAAA,4HAAa,EAAC,WAAW,YAAY,EAAE;QACvD,IAAI,SAAS;YACX,YAAY,CAAA,kBAAmB,gBAAgB,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;YACpE,gBAAgB,iCAAiC;QACnD,OAAO;YACL,MAAM;QACR;IACF,GAAG;QAAC,YAAY,EAAE;QAAE;KAAa;IAEjC,MAAM,mBAAmB,aAAa,QAAQ,GAAG,aAAa,YAAY,CAAC,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,YAAY,EAAE,IAAI;IAEhH,qBACE;;0BAEE,8OAAC;gBAAI,WAAU;;kCACZ,8OAAC;wBAAI,WAAU;;4BACV,aAAa,QAAQ,IAAI,mBACvB,wEAAwE;0CACxE,8OAAC;gCAAI,KAAK,iBAAiB,OAAO,CAAC,SAAS;gCAAE,KAAK,iBAAiB,OAAO,CAAC,WAAW;gCAAE,WAAU;;;;;yFAEnG,8OAAC;gCAAI,WAAU;0CAAsG;;;;;;0CAExH,8OAAC;0CACE,cAAA,8OAAC;oCAAG,WAAU;8CAAmC,aAAa,WAAW;;;;;;;;;;;;;;;;;oBAG/E,CAAC,aAAa,QAAQ,kBACpB,8OAAC;wBAAO,SAAS;wBAAsB,WAAW,CAAC,2CAA2C,EAAE,qBAAqB,gCAAgC,uDAAuD;kCACxM,cAAA,8OAAC;4BAAI,OAAM;4BAA6B,WAAU;4BAAU,MAAK;4BAAO,SAAQ;4BAAY,QAAO;sCACjG,cAAA,8OAAC;gCAAK,eAAc;gCAAQ,gBAAe;gCAAQ,aAAa;gCAAG,GAAE;;;;;;;;;;;;;;;;;;;;;;0BAOjF,8OAAC;gBAAI,WAAU;;oBACZ,SAAS,GAAG,CAAC,CAAC;wBACZ,MAAM,gBAAgB,IAAA,sIAAgB,EAAC,aAAa,KAAK,cAAc;wBACvE,MAAM,eAAe,IAAI,MAAM,KAAK,YAAY,EAAE;wBAClD,qBACC,8OAAC;4BAEC,WAAW,CAAC,sCAAsC,EAChD,eAAe,gBAAgB,iBAC/B;4BACF,cAAc,IAAM,kBAAkB,IAAI,EAAE;4BAC5C,cAAc,IAAM,kBAAkB;;gCAErC,CAAC,8BACA,8OAAC;oCACC,KAAK,IAAI,aAAa;oCACtB,KAAK,IAAI,eAAe;oCACxB,WAAU;oCACV,SAAS,IAAM,cAAc,IAAI,MAAM;;;;;;8CAG3C,8OAAC;oCAAI,WAAU;;sDACb,8OAAC;4CACC,WAAW,CAAC,wBAAwB,EAClC,eAAe,4BAA4B,6BAC3C;;gDAED,CAAC,8BACA,8OAAC;oDACG,WAAU;oDACV,SAAS,IAAM,cAAc,IAAI,MAAM;8DAEtC,IAAI,eAAe;;;;;;8DAG1B,8OAAC;oDAAE,WAAU;oDAAU,OAAO;wDAAE,YAAY;oDAAW;8DAAI,IAAI,IAAI;;;;;;;;;;;;sDAErE,8OAAC;4CAAE,WAAW,CAAC,aAAa,EAAE,eAAe,2BAA2B,iBAAiB;sDACtF,IAAI,SAAS,CAAC,kBAAkB,CAAC,EAAE,EAAE;gDAAE,MAAM;gDAAW,QAAQ;4CAAU;;;;;;;;;;;;gCAG9E,mBAAmB,IAAI,EAAE,IAAI,+BAC5B,8OAAC;oCAAI,WAAW,CAAC,eAAe,EAAE,eAAe,kCAAkC,iCAAiC;8CAClH,cAAA,8OAAC;wCAAI,WAAU;kDACb,cAAA,8OAAC;4CACC,SAAS,IAAM,oBAAoB,IAAI,EAAE;4CACzC,WAAU;;8DAEV,8OAAC;oDAAI,OAAM;oDAA6B,WAAU;oDAAU,SAAQ;oDAAY,MAAK;8DACnF,cAAA,8OAAC;wDAAK,UAAS;wDAAU,GAAE;wDAAiM,UAAS;;;;;;;;;;;8DAEvO,8OAAC;8DAAK;;;;;;;;;;;;;;;;;;;;;;;2BA7CT,IAAI,EAAE;;;;;oBAoDjB;kCACA,8OAAC;wBAAI,KAAK;;;;;;;;;;;;0BAIZ,8OAAC;gBAAI,WAAU;0BACZ,+BACC,8OAAC;oBAAK,UAAU;oBAAmB,WAAU;;sCAC3C,8OAAC;4BACC,MAAK;4BACL,aAAa,CAAC,QAAQ,EAAE,aAAa,WAAW,CAAC,GAAG,CAAC;4BACrD,cAAW;4BACX,OAAO;4BACP,UAAU,CAAC,IAAM,cAAc,EAAE,MAAM,CAAC,KAAK;4BAC7C,WAAU;;;;;;sCAEZ,8OAAC,6IAAM;4BAAC,MAAK;sCAAS;;;;;;;;;;;6EAGtB,8OAAC;oBAAI,WAAU;8BAA8E;;;;;;;;;;;;;AAOzG;uCAEe"}},
    {"offset": {"line": 1317, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/ui/Modal.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useEffect } from 'react';\r\n\r\ninterface ModalProps {\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  title: string;\r\n  children: React.ReactNode;\r\n}\r\n\r\nconst Modal: React.FC<ModalProps> = ({ isOpen, onClose, title, children }) => {\r\n  useEffect(() => {\r\n    const handleEscape = (event: KeyboardEvent) => {\r\n      if (event.key === 'Escape') {\r\n        onClose();\r\n      }\r\n    };\r\n    document.addEventListener('keydown', handleEscape);\r\n    return () => {\r\n      document.removeEventListener('keydown', handleEscape);\r\n    };\r\n  }, [onClose]);\r\n\r\n  if (!isOpen) return null;\r\n\r\n  return (\r\n    <div\r\n      className=\"fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-start overflow-y-auto p-4 sm:p-10\"\r\n      aria-labelledby=\"modal-title\"\r\n      role=\"dialog\"\r\n      aria-modal=\"true\"\r\n      onClick={onClose}\r\n    >\r\n      <div\r\n        className=\"bg-white rounded-lg shadow-xl max-w-lg w-full overflow-hidden\"\r\n        onClick={(e) => e.stopPropagation()} // Prevent clicks inside the modal from closing it\r\n      >\r\n        <div className=\"flex justify-between items-center p-4 border-b border-gray-200\">\r\n          <h2 id=\"modal-title\" className=\"text-lg font-semibold text-gray-900\">\r\n            {title}\r\n          </h2>\r\n          <button\r\n            onClick={onClose}\r\n            className=\"text-gray-400 hover:text-gray-600\"\r\n            aria-label=\"Close modal\"\r\n          >\r\n            <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-6 w-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n            </svg>\r\n          </button>\r\n        </div>\r\n        <div className=\"p-6\">\r\n          {children}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Modal;"],"names":[],"mappings":";;;;;AAEA;AAFA;;;AAWA,MAAM,QAA8B,CAAC,EAAE,MAAM,EAAE,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE;IACvE,IAAA,kNAAS,EAAC;QACR,MAAM,eAAe,CAAC;YACpB,IAAI,MAAM,GAAG,KAAK,UAAU;gBAC1B;YACF;QACF;QACA,SAAS,gBAAgB,CAAC,WAAW;QACrC,OAAO;YACL,SAAS,mBAAmB,CAAC,WAAW;QAC1C;IACF,GAAG;QAAC;KAAQ;IAEZ,IAAI,CAAC,QAAQ,OAAO;IAEpB,qBACE,8OAAC;QACC,WAAU;QACV,mBAAgB;QAChB,MAAK;QACL,cAAW;QACX,SAAS;kBAET,cAAA,8OAAC;YACC,WAAU;YACV,SAAS,CAAC,IAAM,EAAE,eAAe;;8BAEjC,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;4BAAG,IAAG;4BAAc,WAAU;sCAC5B;;;;;;sCAEH,8OAAC;4BACC,SAAS;4BACT,WAAU;4BACV,cAAW;sCAEX,cAAA,8OAAC;gCAAI,OAAM;gCAA6B,WAAU;gCAAU,MAAK;gCAAO,SAAQ;gCAAY,QAAO;0CACjG,cAAA,8OAAC;oCAAK,eAAc;oCAAQ,gBAAe;oCAAQ,aAAa;oCAAG,GAAE;;;;;;;;;;;;;;;;;;;;;;8BAI3E,8OAAC;oBAAI,WAAU;8BACZ;;;;;;;;;;;;;;;;;AAKX;uCAEe"}},
    {"offset": {"line": 1424, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/messages/NewMessageModal.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useState, useMemo } from 'react';\r\nimport type { User } from '../../types';\r\nimport { getAllUsers } from '../../../lib/data';\r\nimport Input from '../ui/Input';\r\nimport Button from '../ui/Button';\r\n\r\ninterface NewMessageModalProps {\r\n  currentUser: User;\r\n  onClose: () => void;\r\n  onStartConversation: (recipientId: string) => void;\r\n}\r\n\r\nconst NewMessageModal: React.FC<NewMessageModalProps> = ({ currentUser, onClose, onStartConversation }) => {\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n\r\n  const allOtherUsers = useMemo(() => {\r\n    return getAllUsers().filter(u => u.id !== currentUser.id);\r\n  }, [currentUser.id]);\r\n\r\n  const filteredUsers = useMemo(() => {\r\n    if (!searchTerm.trim()) {\r\n      return allOtherUsers;\r\n    }\r\n    const lowercasedTerm = searchTerm.toLowerCase();\r\n    return allOtherUsers.filter(\r\n      u =>\r\n        // FIX: Access displayName from the nested profile object.\r\n        u.profile.displayName.toLowerCase().includes(lowercasedTerm) ||\r\n        u.email.toLowerCase().includes(lowercasedTerm)\r\n    );\r\n  }, [allOtherUsers, searchTerm]);\r\n\r\n  return (\r\n    <div className=\"flex flex-col\" style={{ minHeight: '50vh' }}>\r\n      <Input\r\n        label=\"\"\r\n        id=\"user-search\"\r\n        type=\"search\"\r\n        placeholder=\"Search for a user by name or email...\"\r\n        value={searchTerm}\r\n        onChange={e => setSearchTerm(e.target.value)}\r\n      />\r\n\r\n      <div className=\"flex-1 mt-4 -mx-6 px-2 overflow-y-auto\">\r\n        <ul className=\"divide-y divide-gray-200\">\r\n          {filteredUsers.length > 0 ? (\r\n            filteredUsers.map(user => (\r\n              <li\r\n                key={user.id}\r\n                className=\"p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50\"\r\n                onClick={() => onStartConversation(user.id)}\r\n              >\r\n                <div className=\"flex items-center space-x-4\">\r\n                  {/* FIX: Access avatarUrl and displayName from the nested profile object. */}\r\n                  <img src={user.profile.avatarUrl} alt={user.profile.displayName} className=\"w-10 h-10 rounded-full\" />\r\n                  <div>\r\n                    <p className=\"font-semibold text-gray-800\">{user.profile.displayName}</p>\r\n                    <p className=\"text-sm text-gray-500\">{user.email}</p>\r\n                  </div>\r\n                </div>\r\n              </li>\r\n            ))\r\n          ) : (\r\n            <li className=\"p-8 text-center text-sm text-gray-500\">\r\n              No users found matching your search.\r\n            </li>\r\n          )}\r\n        </ul>\r\n      </div>\r\n\r\n      <div className=\"pt-4 border-t border-gray-200 text-right\">\r\n        <Button variant=\"secondary\" onClick={onClose}>\r\n          Cancel\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default NewMessageModal;\r\n"],"names":[],"mappings":";;;;;AAEA;AAEA;AACA;AACA;AANA;;;;;;AAcA,MAAM,kBAAkD,CAAC,EAAE,WAAW,EAAE,OAAO,EAAE,mBAAmB,EAAE;IACpG,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAC;IAE7C,MAAM,gBAAgB,IAAA,gNAAO,EAAC;QAC5B,OAAO,IAAA,0HAAW,IAAG,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,YAAY,EAAE;IAC1D,GAAG;QAAC,YAAY,EAAE;KAAC;IAEnB,MAAM,gBAAgB,IAAA,gNAAO,EAAC;QAC5B,IAAI,CAAC,WAAW,IAAI,IAAI;YACtB,OAAO;QACT;QACA,MAAM,iBAAiB,WAAW,WAAW;QAC7C,OAAO,cAAc,MAAM,CACzB,CAAA,IACE,0DAA0D;YAC1D,EAAE,OAAO,CAAC,WAAW,CAAC,WAAW,GAAG,QAAQ,CAAC,mBAC7C,EAAE,KAAK,CAAC,WAAW,GAAG,QAAQ,CAAC;IAErC,GAAG;QAAC;QAAe;KAAW;IAE9B,qBACE,8OAAC;QAAI,WAAU;QAAgB,OAAO;YAAE,WAAW;QAAO;;0BACxD,8OAAC,4IAAK;gBACJ,OAAM;gBACN,IAAG;gBACH,MAAK;gBACL,aAAY;gBACZ,OAAO;gBACP,UAAU,CAAA,IAAK,cAAc,EAAE,MAAM,CAAC,KAAK;;;;;;0BAG7C,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC;oBAAG,WAAU;8BACX,cAAc,MAAM,GAAG,IACtB,cAAc,GAAG,CAAC,CAAA,qBAChB,8OAAC;4BAEC,WAAU;4BACV,SAAS,IAAM,oBAAoB,KAAK,EAAE;sCAE1C,cAAA,8OAAC;gCAAI,WAAU;;kDAEb,8OAAC;wCAAI,KAAK,KAAK,OAAO,CAAC,SAAS;wCAAE,KAAK,KAAK,OAAO,CAAC,WAAW;wCAAE,WAAU;;;;;;kDAC3E,8OAAC;;0DACC,8OAAC;gDAAE,WAAU;0DAA+B,KAAK,OAAO,CAAC,WAAW;;;;;;0DACpE,8OAAC;gDAAE,WAAU;0DAAyB,KAAK,KAAK;;;;;;;;;;;;;;;;;;2BAT/C,KAAK,EAAE;;;;sFAehB,8OAAC;wBAAG,WAAU;kCAAwC;;;;;;;;;;;;;;;;0BAO5D,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC,6IAAM;oBAAC,SAAQ;oBAAY,SAAS;8BAAS;;;;;;;;;;;;;;;;;AAMtD;uCAEe"}},
    {"offset": {"line": 1574, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/components/messages/MessagesPage.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useState, useMemo, useEffect, useCallback } from 'react';\r\nimport type { User, EnrichedConversation } from '../../types';\r\nimport { getConversationsForUser, getOrCreateDirectConversation } from '../../../lib/data';\r\nimport ConversationList from './ConversationList';\r\nimport MessageStream from './MessageStream';\r\nimport Button from '../ui/Button';\r\nimport Modal from '../ui/Modal';\r\nimport NewMessageModal from './NewMessageModal';\r\n\r\ninterface MessagesPageProps {\r\n  currentUser: User;\r\n  onBack: () => void;\r\n  onViewProfile: (userId: string) => void;\r\n  initialActiveConversationId?: string | null;\r\n}\r\n\r\nconst MessagesPage: React.FC<MessagesPageProps> = ({ currentUser, onBack, onViewProfile, initialActiveConversationId }) => {\r\n  const [updateTrigger, setUpdateTrigger] = useState(0);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [isNewMessageModalOpen, setIsNewMessageModalOpen] = useState(false);\r\n  const [newlyCreatedConvId, setNewlyCreatedConvId] = useState<string | null>(null);\r\n\r\n  const allUserConversations = useMemo(() => getConversationsForUser(currentUser.id), [currentUser.id, updateTrigger]);\r\n  \r\n  const [activeConversation, setActiveConversation] = useState<EnrichedConversation | null>(() => {\r\n    if (initialActiveConversationId) {\r\n      return allUserConversations.find(c => c.id === initialActiveConversationId) || allUserConversations[0] || null;\r\n    }\r\n    return allUserConversations.length > 0 ? allUserConversations[0] : null;\r\n  });\r\n\r\n  useEffect(() => {\r\n    const conversationIdToSelect = newlyCreatedConvId || initialActiveConversationId;\r\n    if (conversationIdToSelect) {\r\n      const conversationToActivate = allUserConversations.find(c => c.id === conversationIdToSelect);\r\n      if (conversationToActivate) {\r\n        setActiveConversation(conversationToActivate);\r\n        if (newlyCreatedConvId) {\r\n          setNewlyCreatedConvId(null);\r\n        }\r\n      }\r\n    } else if (!allUserConversations.some(c => c.id === activeConversation?.id)) {\r\n        // If current active conversation is gone, select the first one.\r\n        setActiveConversation(allUserConversations[0] || null);\r\n    }\r\n  }, [initialActiveConversationId, allUserConversations, newlyCreatedConvId, activeConversation]);\r\n  \r\n  const handleStartConversation = useCallback((recipientId: string) => {\r\n    const conversation = getOrCreateDirectConversation(currentUser.id, recipientId);\r\n    setIsNewMessageModalOpen(false);\r\n    setUpdateTrigger(t => t + 1);\r\n    setNewlyCreatedConvId(conversation.id);\r\n  }, [currentUser.id]);\r\n\r\n  const forceConversationListUpdate = useCallback(() => {\r\n    setUpdateTrigger(c => c + 1);\r\n  }, []);\r\n\r\n  return (\r\n    <div>\r\n        <header className=\"bg-white shadow-sm sticky top-0 z-10\">\r\n          <div className=\"max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center justify-between\">\r\n            <div className=\"flex items-center space-x-3\">\r\n              <Button variant=\"secondary\" size=\"sm\" onClick={onBack}>&larr; Back</Button>\r\n              <h1 className=\"text-xl font-bold text-gray-800\">Messages</h1>\r\n            </div>\r\n            <Button onClick={() => setIsNewMessageModalOpen(true)}>\r\n              + New Message\r\n            </Button>\r\n          </div>\r\n        </header>\r\n\r\n        <div className=\"max-w-7xl mx-auto sm:px-6 lg:px-8 mt-8\">\r\n            <div className=\"flex h-[calc(100vh-170px)] bg-white rounded-lg shadow-sm overflow-hidden\">\r\n            <div className=\"w-1/3 border-r border-gray-200 flex flex-col\">\r\n                <ConversationList\r\n                  conversations={allUserConversations}\r\n                  currentUser={currentUser}\r\n                  activeConversationId={activeConversation?.id}\r\n                  onConversationSelect={setActiveConversation}\r\n                  searchTerm={searchTerm}\r\n                  onSearchChange={setSearchTerm}\r\n                />\r\n            </div>\r\n            <div className=\"w-2/3 flex flex-col\">\r\n                {activeConversation ? (\r\n                <MessageStream\r\n                    key={activeConversation.id} // Re-mount component when conversation changes\r\n                    currentUser={currentUser}\r\n                    conversation={activeConversation}\r\n                    onViewProfile={onViewProfile}\r\n                    isDetailsPanelOpen={false}\r\n                    onToggleDetailsPanel={() => {}}\r\n                    onMarkAsRead={forceConversationListUpdate}\r\n                />\r\n                ) : (\r\n                <div className=\"flex-1 flex items-center justify-center text-center\">\r\n                    <div>\r\n                    <h3 className=\"text-lg font-medium text-gray-900\">Select a Conversation</h3>\r\n                    <p className=\"mt-1 text-sm text-gray-500\">\r\n                        Choose a conversation from the left or start a new one.\r\n                    </p>\r\n                    </div>\r\n                </div>\r\n                )}\r\n            </div>\r\n            </div>\r\n        </div>\r\n        <Modal isOpen={isNewMessageModalOpen} onClose={() => setIsNewMessageModalOpen(false)} title=\"Start a New Conversation\">\r\n            <NewMessageModal \r\n                currentUser={currentUser}\r\n                onClose={() => setIsNewMessageModalOpen(false)}\r\n                onStartConversation={handleStartConversation}\r\n            />\r\n        </Modal>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default MessagesPage;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1808, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/josep/VSCODEprojects/Temple/Temple4/app/messages/MessagesPageClient.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useRouter } from 'next/navigation';\r\nimport MessagesPage from '../components/messages/MessagesPage';\r\nimport type { User, EnrichedConversation } from '../../types';\r\n\r\ninterface MessagesPageClientProps {\r\n  user: User;\r\n  initialConversations: EnrichedConversation[];\r\n}\r\n\r\nexport default function MessagesPageClient({ user, initialConversations }: MessagesPageClientProps) {\r\n  const router = useRouter();\r\n  \r\n  return (\r\n    <MessagesPage \r\n      currentUser={user}\r\n      initialConversations={initialConversations}\r\n      onBack={() => router.push('/')} \r\n      onViewProfile={(userId) => router.push(`/profile/${userId}`)} \r\n    />\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAHA;;;;AAWe,SAAS,mBAAmB,EAAE,IAAI,EAAE,oBAAoB,EAA2B;IAChG,MAAM,SAAS,IAAA,+IAAS;IAExB,qBACE,8OAAC,yJAAY;QACX,aAAa;QACb,sBAAsB;QACtB,QAAQ,IAAM,OAAO,IAAI,CAAC;QAC1B,eAAe,CAAC,SAAW,OAAO,IAAI,CAAC,CAAC,SAAS,EAAE,QAAQ;;;;;;AAGjE"}}]
}