# Ticket 0007 — Tenant Isolation Audit (Messaging & Donations)

Summary

- Scope: Verify tenant-scoped API routes enforce membership and tenant isolation guarantees and document where `assertApprovedMember` is used or where equivalent permission checks are present.
- Outcome: Core messaging and donation flows hardened. Notifications centralized and tenant-scoped outbox enqueues require an actor and membership validation.

Findings (by route category)

1. Routes that explicitly use `assertApprovedMember`
- Messaging / conversations (actor-driven message endpoints): `app/api/conversations/[id]/messages/route.ts` and `lib/services/message-service.ts` — calls `assertApprovedMember` for TENANT-scoped conversations.
- Trip donations: `app/api/tenants/[tenantId]/trips/[tripId]/donations/route.ts` — now calls `assertApprovedMember` for `MEMBERS_ONLY` fundraisers.
- Notification enqueue: `lib/services/notification-service.ts` — requires `actorUserId` for tenant-scoped enqueues and calls `assertApprovedMember`.

2. Routes that use the platform permission helper (`can`) or tenant context
- Many tenant administrative or content routes use `can(user, tenant, '<permission>')` which performs role/permission checks that implicitly require membership for actions that must be restricted to admins/staff. Examples:
  - Events (`app/api/tenants/[tenantId]/events/*`)
  - Sermons, Podcasts, Books, Resources, Facilities, Admin contact endpoints
  - These routes perform an authenticated user check and then call `can(...)` before create/update/delete.

3. Routes that use `getTenantContext` or explicit membership checks for public/members-only behavior
- Donation leaderboard and settings: `app/api/tenants/[tenantId]/donations/records/route.ts` uses `getTenantContext` and checks `context.membership` / `context.isPublic` and was updated to enqueue notifications through `NotificationService` for authenticated donors.
- Members endpoints: `app/api/tenants/[tenantId]/members/*` use membership lookups and role checks.

4. Seed and archive files (non-runtime)
- `prisma/archive/seed.ts` contains archival/seed notification writes via `prisma.notification.createMany`. These are intentional for deterministic seed data; converting them to the outbox pattern is optional and will change seed semantics.

Conclusion and Recommendations

- Status: Core runtime routes for messaging and donations are hardened. Notification enqueuing requires an actor for tenant-scoped operations and performs membership validation.

- Recommendation A (already applied): Keep using `assertApprovedMember` for actor-driven, tenant-scoped operations (messages, tenant outbox enqueues, trip donations). This centralization reduces duplicated logic and enforces consistent errors.

- Recommendation B: Continue to rely on the `can(...)` permission helper for admin/staff protected endpoints — it's the correct abstraction for role-based permission checks.

- Recommendation C (optional): Convert seed/archive notification writes to use `NotificationService` if you want seeds to be generated under the same outbox guarantees. This will change seed semantics and should be done consciously.

Files reviewed (representative list)
- `app/api/conversations/[id]/messages/route.ts`
- `lib/services/message-service.ts`
- `lib/services/notification-service.ts`
- `app/api/tenants/[tenantId]/donations/records/route.ts`
- `app/api/tenants/[tenantId]/trips/[tripId]/donations/route.ts`
- `app/api/tenants/[tenantId]/events/*`
- `app/api/tenants/[tenantId]/members/*`
- `prisma/archive/seed.ts`

Next actions (you can pick one)
- Close Ticket 0007 as complete (if you accept seed/archival direct writes remaining). I can prepare a PR and changelog entry.
- If you want seeds converted or additional automated checks (e.g., eslint rule to disallow `prisma.notification.createMany` in runtime code), I can implement those.


Audit performed on: 2025-11-27
Generated by: repo audit tooling + manual review
