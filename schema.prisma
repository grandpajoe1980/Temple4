// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --- ENUMS ---

enum TenantRole {
  MEMBER
  STAFF
  CLERGY
  MODERATOR
  ADMIN
}

enum MembershipStatus {
  PENDING
  APPROVED
  REJECTED
  BANNED
}

enum OnboardingStatus {
  PENDING
  PACKET_QUEUED
  PACKET_SENT
  COMPLETED
}

enum MembershipApprovalMode {
  OPEN
  APPROVAL_REQUIRED
}

enum CommunityPostType {
  PRAYER_REQUEST
  TANGIBLE_NEED
}

enum CommunityPostStatus {
  PENDING_APPROVAL
  PUBLISHED
  FULFILLED
}

enum ResourceVisibility {
  PUBLIC
  MEMBERS_ONLY
}

enum FileType {
  PDF
  DOCX
  MP3
  JPG
  PNG
  OTHER
}

enum ContactSubmissionStatus {
  UNREAD
  READ
  ARCHIVED
}

enum ServiceCategory {
  CEREMONY
  EDUCATION
  FACILITY
  COUNSELING
  OTHER
}

enum ActionType {
  IMPERSONATE_START
  IMPERSONATE_END
  CREATE_POST
  DELETE_POST
  BAN_USER
  UNBAN_USER
  DELETE_MESSAGE
  USER_JOINED_TENANT
  MEMBERSHIP_STATUS_UPDATED
  MEMBER_ROLES_UPDATED
  MEMBERSHIP_PROFILE_UPDATED
  USER_REGISTERED
  USER_PROFILE_UPDATED
  ADMIN_UPDATED_USER_PROFILE
  TENANT_PERMISSIONS_UPDATED
  TENANT_BRANDING_SOCIAL_LINK_CREATED
  TENANT_BRANDING_SOCIAL_LINK_UPDATED
  TENANT_BRANDING_SOCIAL_LINK_DELETED
  DONATION_FUND_CREATED
  DONATION_FUND_UPDATED
  DONATION_FUND_ARCHIVED
}

enum NotificationType {
  NEW_DIRECT_MESSAGE
  NEW_ANNOUNCEMENT
  MEMBERSHIP_APPROVED
  NEW_CONTACT_SUBMISSION
  DONATION_FUND_UPDATED
}

enum FundType {
  TITHE
  OFFERING
  PROJECT
  SPECIAL
}

enum FundVisibility {
  PUBLIC
  MEMBERS_ONLY
  HIDDEN
}

enum VolunteerStatus {
  CONFIRMED
  CANCELED
}

enum SmallGroupRole {
  LEADER
  MEMBER
}

enum SmallGroupStatus {
  OPEN
  CLOSED
  FULL
  ARCHIVED
}

enum JoinPolicy {
  OPEN
  APPROVAL
}

enum SmallGroupMemberRole {
  MEMBER
  LEADER
  CO_LEADER
  ADMIN_ADDED
}

enum RSVPStatus {
  GOING
  INTERESTED
  NOT_GOING
  WAITLISTED
}

enum EventVisibility {
  PUBLIC
  MEMBERS_ONLY
  PRIVATE_LINK
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
}

enum TripStatus {
  PLANNING
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELED
  ARCHIVED
}

enum TripMemberRole {
  LEADER
  CO_LEADER
  MEMBER
  SUPPORT
}

enum TravelSegmentType {
  BUS
  FLIGHT
  TRAIN
  BOAT
  CARPOOL
  LODGING
  OTHER
}

enum TripDonationStatus {
  PLEDGED
  AUTHORIZED
  SETTLED
  REFUNDED
  CANCELED
}

enum OutboxStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

enum ConversationScope {
  GLOBAL
  TENANT
}

enum ConversationKind {
  DM
  GROUP
  CHANNEL
}

// --- USER-RELATED MODELS ---

model User {
  id                              String                    @id @default(cuid())
  email                           String                    @unique
  password                        String?
  isSuperAdmin                    Boolean                   @default(false)
  profile                         UserProfile?
  privacySettings                 UserPrivacySettings?
  accountSettings                 AccountSettings?
  notificationPreferences         Json?
  memberships                     UserTenantMembership[]
  posts                           Post[]
  events                          Event[]
  mediaItems                      MediaItem[]
  books                           Book[]
  podcasts                        Podcast[]
  eventRSVPs                      EventRSVP[]
  messages                        ChatMessage[]
  conversations                   ConversationParticipant[]
  postComments                    PostComment[]
  auditLogsAsActor                AuditLog[]                @relation("Actor")
  auditLogsAsEffective            AuditLog[]                @relation("Effective")
  notifications                   Notification[]            @relation("Recipient")
  notificationsAsActor            Notification[]            @relation("Actor")
  donations                       DonationRecord[]
  volunteerSignups                VolunteerSignup[]
  smallGroupMemberships           SmallGroupMembership[]
  uploadedResources               ResourceItem[]
  uploadedSmallGroupResources     SmallGroupResource[]
  authoredSmallGroupAnnouncements SmallGroupAnnouncement[]
  passwordResetTokens             PasswordResetToken[]
  facilityBookings                FacilityBooking[]
  impersonationsAsReal            ImpersonationSession[]    @relation("RealUser")
  impersonationsAsEffective       ImpersonationSession[]    @relation("EffectiveUser")
  profilePosts                    ProfilePost[]
  profilePostReactions            ProfilePostReaction[]
  profilePostComments             ProfilePostComment[]
  profilePostHides                ProfilePostHidden[]
  tripsLed                        Trip[]                    @relation("TripLeader")
  tripsCoLed                      Trip[]                    @relation("TripCoLeader")
  tripsCreated                    Trip[]                    @relation("TripCreator")
  tripMemberships                 TripMember[]
  tripMessages                    TripMessage[]             @relation("TripMessageAuthor")
  tripPhotos                      TripPhoto[]               @relation("TripPhotoUploader")
  tripDonationsDonated            TripDonation[]            @relation("TripDonationDonor")
  tripDonationsSponsored          TripDonation[]            @relation("TripDonationSponsored")
}

model UserProfile {
  id               String    @id @default(cuid())
  userId           String    @unique
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName      String
  avatarUrl        String?
  bio              String?
  locationCity     String?
  locationCountry  String?
  languages        String?
  birthDate        DateTime?
  isBirthdayPublic Boolean   @default(false)
}

model UserPrivacySettings {
  id               String  @id @default(cuid())
  userId           String  @unique
  user             User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  showAffiliations Boolean @default(true)
}

model AccountSettings {
  id                 String  @id @default(cuid())
  userId             String  @unique
  user               User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  timezonePreference String?
  dateFormat         String?
  timeFormat         String?
  languagePreference String?
}

// --- TENANT-RELATED MODELS ---

model Tenant {
  id                      String                   @id @default(cuid())
  name                    String
  slug                    String                   @unique
  creed                   String
  street                  String
  city                    String
  state                   String
  country                 String
  postalCode              String
  contactEmail            String?
  phoneNumber             String?
  description             String
  settings                TenantSettings?
  branding                TenantBranding?
  permissions             Json? // TenantFeaturePermissions
  memberships             UserTenantMembership[]
  posts                   Post[]
  postComments            PostComment[]
  events                  Event[]
  mediaItems              MediaItem[]
  books                   Book[]
  podcasts                Podcast[]
  conversations           Conversation[]
  donationRecords         DonationRecord[]
  funds                   Fund[]
  volunteerNeeds          VolunteerNeed[]
  smallGroups             SmallGroup[]
  smallGroupResources     SmallGroupResource[]
  smallGroupAnnouncements SmallGroupAnnouncement[]
  trips                   Trip[]
  communityPosts          CommunityPost[]
  resourceItems           ResourceItem[]
  contactSubmissions      ContactSubmission[]
  impersonationSessions   ImpersonationSession[]
  serviceOfferings        ServiceOffering[]
  facilities              Facility[]
  profilePostHiddens      ProfilePostHidden[]
}

model TenantBranding {
  id             String  @id @default(cuid())
  tenantId       String  @unique
  tenant         Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  logoUrl        String?
  bannerImageUrl String?
  primaryColor   String?
  accentColor    String?
  customLinks    Json? // Array<{ label: string; url: string }>
  socialLinks    Json? // Array<{ platform: string; url: string; label?: string; showInFooter?: boolean }>
  facebookUrl    String?
  instagramUrl   String?
  twitterUrl     String?
  xUrl           String?
  tiktokUrl      String?
  youtubeUrl     String?
  websiteUrl     String?
  linkedInUrl    String?
}

model ServiceOffering {
  id                   String          @id @default(cuid())
  tenantId             String
  tenant               Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name                 String
  description          String
  category             ServiceCategory
  isPublic             Boolean         @default(true)
  requiresBooking      Boolean         @default(false)
  contactEmailOverride String?
  pricing              String?
  imageUrl             String?
  order                Int             @default(0)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  deletedAt            DateTime?

  @@index([tenantId, category, isPublic])
}

enum FacilityType {
  ROOM
  HALL
  EQUIPMENT
  VEHICLE
  OTHER
}

enum BookingStatus {
  REQUESTED
  APPROVED
  REJECTED
  CANCELLED
}

model Facility {
  id           String             @id @default(cuid())
  tenantId     String
  tenant       Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  type         FacilityType
  location     String?
  capacity     Int?
  imageUrl     String?
  isActive     Boolean            @default(true)
  bookingRules Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  bookings     FacilityBooking[]
  blackouts    FacilityBlackout[]
  isHidden     Boolean            @default(false)

  @@index([tenantId, isActive])
}

model FacilityBooking {
  id            String        @id @default(cuid())
  tenantId      String
  facilityId    String
  facility      Facility      @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  eventId       String?
  event         Event?        @relation(fields: [eventId], references: [id])
  requestedById String
  requestedBy   User          @relation(fields: [requestedById], references: [id])
  startAt       DateTime
  endAt         DateTime
  purpose       String
  status        BookingStatus @default(REQUESTED)
  notes         String?
  createdAt     DateTime      @default(now())

  @@index([tenantId, facilityId, startAt, endAt])
  @@index([requestedById])
}

model FacilityBlackout {
  id         String   @id @default(cuid())
  tenantId   String
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  reason     String?
  startAt    DateTime
  endAt      DateTime
  createdAt  DateTime @default(now())

  @@index([tenantId, facilityId, startAt, endAt])
}

model TenantSettings {
  id                     String                 @id @default(cuid())
  tenantId               String                 @unique
  tenant                 Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isPublic               Boolean                @default(false)
  membershipApprovalMode MembershipApprovalMode @default(APPROVAL_REQUIRED)
  enableCalendar         Boolean                @default(true)
  enablePosts            Boolean                @default(true)
  enableSermons          Boolean                @default(true)
  enablePodcasts         Boolean                @default(true)
  enableBooks            Boolean                @default(true)
  enableMemberDirectory  Boolean                @default(true)
  enableGroupChat        Boolean                @default(true)
  enableComments         Boolean                @default(true)
  enableReactions        Boolean                @default(true)
  enableServices         Boolean                @default(true)
  enableDonations        Boolean                @default(false)
  enableVolunteering     Boolean                @default(false)
  enableSmallGroups      Boolean                @default(false)
  enableTrips            Boolean                @default(false)
  enableLiveStream       Boolean                @default(false)
  enablePhotos           Boolean                @default(true)
  enablePrayerWall       Boolean                @default(false)
  autoApprovePrayerWall  Boolean                @default(false)
  enableResourceCenter   Boolean                @default(false)
  enableTripFundraising  Boolean                @default(false)
  tripCalendarColor      String?                @default("#0EA5E9")
  enableEvents           Boolean                @default(true)
  donationSettings       Json // DonationSettings
  liveStreamSettings     Json // LiveStreamSettings
  visitorVisibility      Json // visitorVisibility
  maxStorageMB           Int                    @default(1000) // Phase F2: Storage quota per tenant
  enableBirthdays        Boolean                @default(false)
  welcomePacketUrl       String?
  welcomePacketVersion   Int?                   @default(1)
  newMemberAlertChannels Json                   @default("[\"email\"]")
}

model UserTenantMembership {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  status      MembershipStatus
  roles       UserTenantRole[]
  displayName String?
  welcomePacketUrl     String?
  welcomePacketVersion Int?
  onboardingStatus     OnboardingStatus @default(PENDING)
  alertSentAt          DateTime?
  alertChannels        Json             @default("[]")

  @@unique([userId, tenantId])
}

model UserTenantRole {
  id           String               @id @default(cuid())
  membershipId String
  membership   UserTenantMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  role         TenantRole
  displayTitle String?
  isPrimary    Boolean              @default(false)
}

// --- CONTENT & MESSAGING ---

model Post {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  authorUserId String
  author       User      @relation(fields: [authorUserId], references: [id])
  type         String // 'BLOG' | 'ANNOUNCEMENT' | 'BOOK'
  title        String
  body         String
  isPublished  Boolean   @default(false)
  publishedAt  DateTime  @default(now())
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  comments PostComment[]
}

model PostComment {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  postId       String
  post         Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorUserId String
  author       User     @relation(fields: [authorUserId], references: [id])
  body         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([postId])
  @@index([tenantId, createdAt])
}

model Event {
  id                   String               @id @default(cuid())
  tenantId             String
  tenant               Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdByUserId      String
  creator              User                 @relation(fields: [createdByUserId], references: [id])
  title                String
  description          String?
  startDateTime        DateTime
  endDateTime          DateTime?
  isOnline             Boolean              @default(false)
  onlineUrl            String?
  allDay               Boolean              @default(false)
  visibility           EventVisibility      @default(MEMBERS_ONLY)
  status               EventStatus          @default(DRAFT)
  capacityLimit        Int?
  waitlistEnabled      Boolean              @default(false)
  locationText         String?
  locationId           String?
  // location relation omitted to avoid modifying Facility model; use locationId to reference a Facility if needed
  posterStorageKey     String?
  posterUrl            String?
  registrationRequired Boolean              @default(false)
  registrationOpenAt   DateTime?
  registrationCloseAt  DateTime?
  price                Float?
  url                  String?
  organizerId          String?
  // organizer relation intentionally not modeled to avoid ambiguous relations on User
  cancellationReason   String?
  tags                 Json? // array of tags stored as JSON
  recurrenceGroupId    String?
  deletedAt            DateTime?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime?            @updatedAt
  rsvps                EventRSVP[]
  volunteerRoles       EventVolunteerRole[]
  facilityBookings     FacilityBooking[]
}

model EventRSVP {
  id          String     @id @default(cuid())
  userId      String?
  user        User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  guestEmail  String?
  guestName   String?
  status      RSVPStatus @default(GOING)
  role        String?    @default("ATTENDEE")
  volunteerRoleId String?
  volunteerRole   EventVolunteerRole? @relation(fields: [volunteerRoleId], references: [id])
  notes       String?
  checkInTime DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([userId, eventId], name: "unique_user_event_rsvp")
}

model EventVolunteerRole {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  roleName  String
  capacity  Int      @default(1)
  rsvps     EventRSVP[]
  createdAt DateTime @default(now())

  @@index([eventId])
}

model MediaItem {
  id           String    @id @default(cuid())
  tenantId     String?
  tenant       Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  authorUserId String
  author       User      @relation(fields: [authorUserId], references: [id])
  type         String // 'SERMON_VIDEO' | 'PODCAST_AUDIO'
  title        String
  description  String
  embedUrl     String
  publishedAt  DateTime  @default(now())
  deletedAt    DateTime?
  // File upload fields (Phase F2)
  storageKey   String? // e.g., "tenants/abc123/media/xyz.jpg"
  mimeType     String? // e.g., "image/jpeg"
  fileSize     Int? // bytes
  uploadedAt   DateTime  @default(now())
}

model Book {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  authorUserId String
  author       User      @relation(fields: [authorUserId], references: [id])
  title        String
  authorName   String // Book author name (not platform user)
  description  String?
  imageUrl     String?
  pdfUrl       String? // Optional PDF link
  externalUrl  String? // Link to purchase or external resource
  isPublished  Boolean   @default(false)
  publishedAt  DateTime?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Podcast {
  id           String    @id @default(cuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  authorUserId String
  author       User      @relation(fields: [authorUserId], references: [id])
  title        String
  description  String?
  audioUrl     String
  imageUrl     String?
  duration     Int? // Duration in seconds
  isPublished  Boolean   @default(false)
  publishedAt  DateTime?
  deletedAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model ChatMessage {
  id             String                    @id @default(cuid())
  conversationId String
  conversation   Conversation              @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User                      @relation(fields: [userId], references: [id])
  text           String
  createdAt      DateTime                  @default(now())
  isDeleted      Boolean                   @default(false)
  readBy         ConversationParticipant[] @relation("LastReadMessage")
}

model Conversation {
  id              String                    @id @default(cuid())
  tenantId        String?
  tenant          Tenant?                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name            String?
  isDirectMessage Boolean                   @default(false)
  scope           ConversationScope         @default(GLOBAL)
  kind            ConversationKind          @default(GROUP)
  participants    ConversationParticipant[]
  messages        ChatMessage[]

  @@index([scope, tenantId])
}

model ConversationParticipant {
  id                String       @id @default(cuid())
  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId            String
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastReadMessageId String?
  lastReadMessage   ChatMessage? @relation("LastReadMessage", fields: [lastReadMessageId], references: [id])

  @@unique([conversationId, userId])
}

// --- ADMIN & AUDIT TYPES ---

model AuditLog {
  id              String     @id @default(cuid())
  actorUserId     String
  actorUser       User       @relation("Actor", fields: [actorUserId], references: [id])
  effectiveUserId String?
  effectiveUser   User?      @relation("Effective", fields: [effectiveUserId], references: [id])
  actionType      ActionType
  entityType      String?
  entityId        String?
  metadata        Json?
  createdAt       DateTime   @default(now())
}

// --- NOTIFICATION MODELS ---

model Notification {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation("Recipient", fields: [userId], references: [id])
  actorUserId String?
  actor       User?            @relation("Actor", fields: [actorUserId], references: [id])
  type        NotificationType
  message     String
  link        String?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
}

// --- DONATION MODELS ---

model DonationRecord {
  id                       String   @id @default(cuid())
  tenantId                 String
  tenant                   Tenant   @relation(fields: [tenantId], references: [id])
  userId                   String?
  user                     User?    @relation(fields: [userId], references: [id])
  displayName              String
  fundId                   String
  fund                     Fund     @relation(fields: [fundId], references: [id], onDelete: Cascade)
  amount                   Float
  currency                 String
  donatedAt                DateTime @default(now())
  isAnonymousOnLeaderboard Boolean  @default(false)
  message                  String?
  designationNote          String?
  campaignMetadata         Json?
  paymentBrand             String?
  paymentLast4             String?
}

model Fund {
  id                 String         @id @default(cuid())
  tenantId           String
  tenant             Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name               String
  description        String?
  type               FundType
  visibility         FundVisibility @default(PUBLIC)
  currency           String         @default("USD")
  goalAmountCents    Int?
  startDate          DateTime?
  endDate            DateTime?
  minAmountCents     Int?
  maxAmountCents     Int?
  allowAnonymous     Boolean        @default(true)
  archivedAt         DateTime?
  campaignMetadata   Json?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  donations          DonationRecord[]

  @@index([tenantId, visibility, archivedAt])
}

// --- VOLUNTEER MODELS ---

model VolunteerNeed {
  id          String            @id @default(cuid())
  tenantId    String
  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  eventId     String?
  title       String
  description String
  date        DateTime
  slotsNeeded Int
  location    String?
  signups     VolunteerSignup[]
}

model VolunteerSignup {
  id         String          @id @default(cuid())
  needId     String
  need       VolunteerNeed   @relation(fields: [needId], references: [id])
  userId     String
  user       User            @relation(fields: [userId], references: [id])
  signedUpAt DateTime        @default(now())
  status     VolunteerStatus

  @@unique([needId, userId])
}

// --- SMALL GROUP MODELS ---

model SmallGroup {
  id                String                   @id @default(cuid())
  tenantId          String
  tenant            Tenant                   @relation(fields: [tenantId], references: [id])
  name              String
  description       String?
  slug              String?                  @unique
  category          String?
  imageUrl          String?
  dayOfWeek         String?
  startTime         String?
  frequency         String?
  format            String?
  locationName      String?
  locationAddress   String?
  onlineMeetingLink String?
  leaderUserId      String?
  meetingSchedule   String?
  status            SmallGroupStatus         @default(OPEN)
  joinPolicy        JoinPolicy               @default(APPROVAL)
  capacity          Int?
  ageFocus          String?
  language          String?
  hasChildcare      Boolean                  @default(false)
  tags              Json?
  isPublic          Boolean                  @default(false)
  isActive          Boolean                  @default(true)
  isHidden          Boolean                  @default(false)
  createdByUserId   String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime?
  archivedAt        DateTime?
  members           SmallGroupMembership[]
  resources         SmallGroupResource[]
  announcements     SmallGroupAnnouncement[]
}

model SmallGroupMembership {
  id            String               @id @default(cuid())
  groupId       String
  group         SmallGroup           @relation(fields: [groupId], references: [id])
  userId        String
  user          User                 @relation(fields: [userId], references: [id])
  role          SmallGroupMemberRole @default(MEMBER)
  status        MembershipStatus     @default(PENDING)
  joinedAt      DateTime             @default(now())
  leftAt        DateTime?
  addedByUserId String?

  @@unique([groupId, userId])
}

// --- TRIP MODELS ---

model Trip {
  id                    String              @id @default(cuid())
  tenantId              String
  tenant                Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name                  String
  summary               String?
  description           String?
  imageUrl              String?
  leaderUserId          String?
  leader                User?               @relation("TripLeader", fields: [leaderUserId], references: [id])
  coLeaderUserId        String?
  coLeader              User?               @relation("TripCoLeader", fields: [coLeaderUserId], references: [id])
  createdByUserId       String?
  creator               User?               @relation("TripCreator", fields: [createdByUserId], references: [id])
  startDate             DateTime?
  endDate               DateTime?
  departureLocation     String?
  destination           String?
  meetingPoint          String?
  status                TripStatus          @default(PLANNING)
  joinPolicy            JoinPolicy          @default(APPROVAL)
  capacity              Int?
  waitlistEnabled       Boolean             @default(true)
  costCents             Int?
  currency              String              @default("USD")
  depositCents          Int?
  allowPartialPayments  Boolean             @default(false)
  allowScholarships     Boolean             @default(false)
  allowMessages         Boolean             @default(true)
  allowPhotos           Boolean             @default(true)
  waiverRequired        Boolean             @default(false)
  waiverUrl             String?
  formUrl               String?
  packingList           Json?
  housingDetails        String?
  transportationNotes   String?
  itineraryJson         Json?
  travelDetails         Json?
  safetyNotes           String?
  fundraisingEnabled    Boolean             @default(false)
  fundraisingGoalCents  Int?
  fundraisingDeadline   DateTime?
  fundraisingVisibility String?
  allowSponsorship      Boolean             @default(false)
  colorHex              String? // calendar color for trips
  isPublic              Boolean             @default(false)
  isHidden              Boolean             @default(false)
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  archivedAt            DateTime?
  members               TripMember[]
  itineraryItems        TripItineraryItem[]
  travelSegments        TripTravelSegment[]
  messages              TripMessage[]
  photos                TripPhoto[]
  donations             TripDonation[]

  @@index([tenantId, status])
}

model TripMember {
  id                String           @id @default(cuid())
  tripId            String
  trip              Trip             @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId            String
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  role              TripMemberRole   @default(MEMBER)
  status            MembershipStatus @default(PENDING)
  joinedAt          DateTime         @default(now())
  leftAt            DateTime?
  waiverAcceptedAt  DateTime?
  emergencyContact  Json?
  travelPreferences Json?
  notes             String?

  @@unique([tripId, userId])
}

model TripItineraryItem {
  id          String    @id @default(cuid())
  tripId      String
  trip        Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime?
  location    String?
  order       Int?
  createdAt   DateTime  @default(now())
}

model TripTravelSegment {
  id               String            @id @default(cuid())
  tripId           String
  trip             Trip              @relation(fields: [tripId], references: [id], onDelete: Cascade)
  type             TravelSegmentType
  carrier          String?
  segmentNumber    String?
  departAt         DateTime?
  arriveAt         DateTime?
  departLocation   String?
  arriveLocation   String?
  confirmationCode String?
  notes            String?
  createdAt        DateTime          @default(now())
}

model TripMessage {
  id           String   @id @default(cuid())
  tripId       String
  trip         Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  authorUserId String
  author       User     @relation("TripMessageAuthor", fields: [authorUserId], references: [id], onDelete: Cascade)
  body         String
  createdAt    DateTime @default(now())
}

model TripPhoto {
  id           String   @id @default(cuid())
  tripId       String
  trip         Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  uploadedById String
  uploadedBy   User     @relation("TripPhotoUploader", fields: [uploadedById], references: [id], onDelete: Cascade)
  imageUrl     String
  caption      String?
  phase        String? // pre, during, post
  createdAt    DateTime @default(now())
}

model TripDonation {
  id              String             @id @default(cuid())
  tripId          String
  trip            Trip               @relation(fields: [tripId], references: [id], onDelete: Cascade)
  donorUserId     String?
  donorUser       User?              @relation("TripDonationDonor", fields: [donorUserId], references: [id], onDelete: Cascade)
  sponsoredUserId String?
  sponsoredUser   User?              @relation("TripDonationSponsored", fields: [sponsoredUserId], references: [id], onDelete: Cascade)
  amountCents     Int
  currency        String             @default("USD")
  status          TripDonationStatus @default(PLEDGED)
  message         String?
  displayName     String?
  isAnonymous     Boolean            @default(false)
  coverFees       Boolean            @default(false)
  createdAt       DateTime           @default(now())

  @@index([tripId])
  @@index([tripId, status])
}

// --- COMMUNITY BOARD / PRAYER WALL MODELS ---

model CommunityPost {
  id           String              @id @default(cuid())
  tenantId     String
  tenant       Tenant              @relation(fields: [tenantId], references: [id])
  authorUserId String?
  type         CommunityPostType
  body         String
  isAnonymous  Boolean
  status       CommunityPostStatus @default(PENDING_APPROVAL)
  createdAt    DateTime            @default(now())
}

// --- RESOURCE CENTER MODELS ---

model ResourceItem {
  id             String             @id @default(cuid())
  tenantId       String
  tenant         Tenant             @relation(fields: [tenantId], references: [id])
  uploaderUserId String
  uploader       User               @relation(fields: [uploaderUserId], references: [id])
  title          String
  description    String
  fileUrl        String
  fileType       FileType
  visibility     ResourceVisibility @default(MEMBERS_ONLY)
  createdAt      DateTime           @default(now())
  // File upload fields (Phase F2)
  storageKey     String? // e.g., "tenants/abc123/resources/xyz.pdf"
  mimeType       String? // e.g., "application/pdf"
  fileSize       Int? // bytes
  uploadedAt     DateTime?
}

model SmallGroupResource {
  id             String     @id @default(cuid())
  tenantId       String
  tenant         Tenant     @relation(fields: [tenantId], references: [id])
  groupId        String
  group          SmallGroup @relation(fields: [groupId], references: [id])
  uploaderUserId String
  uploader       User       @relation(fields: [uploaderUserId], references: [id])
  title          String
  description    String?
  url            String?
  createdAt      DateTime   @default(now())
}

model SmallGroupAnnouncement {
  id           String     @id @default(cuid())
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  groupId      String
  group        SmallGroup @relation(fields: [groupId], references: [id])
  authorUserId String
  author       User       @relation(fields: [authorUserId], references: [id])
  title        String
  body         String
  createdAt    DateTime   @default(now())
}

// --- CONTACT & SUBMISSIONS ---

model ContactSubmission {
  id        String                  @id @default(cuid())
  tenantId  String
  tenant    Tenant                  @relation(fields: [tenantId], references: [id])
  name      String
  email     String
  message   String
  status    ContactSubmissionStatus @default(UNREAD)
  createdAt DateTime                @default(now())
}

// --- AUTH & SECURITY ---

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ImpersonationSession {
  id              String    @id @default(cuid())
  realUserId      String
  realUser        User      @relation("RealUser", fields: [realUserId], references: [id])
  effectiveUserId String
  effectiveUser   User      @relation("EffectiveUser", fields: [effectiveUserId], references: [id])
  tenantId        String?
  tenant          Tenant?   @relation(fields: [tenantId], references: [id])
  reason          String?
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
}

// --- EMAIL SERVICE (Phase F3) ---

model EmailLog {
  id         String   @id @default(cuid())
  tenantId   String?
  recipient  String
  subject    String
  status     String // SENT, FAILED, BOUNCED
  provider   String // RESEND, SENDGRID, MOCK
  providerId String? // External tracking ID
  sentAt     DateTime @default(now())
  error      String?
}

model EmailProviderConfig {
  id        String   @id @default(cuid())
  provider  String
  settings  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Outbox {
  id          String            @id @default(cuid())
  tenantId    String?
  type        NotificationType?
  payload     Json
  status      OutboxStatus      @default(PENDING)
  attempts    Int               @default(0)
  lastError   String?
  runAt       DateTime?         @default(now())
  lockedAt    DateTime?
  processedAt DateTime?
  provider    String?
  createdAt   DateTime          @default(now())

  @@index([status, runAt])
}

// --- PROFILE FEED MODELS ---

enum ProfilePostType {
  TEXT
  IMAGE
  VIDEO
  LINK
  MIXED
}

enum ProfilePostPrivacy {
  PUBLIC
  FRIENDS
  PRIVATE
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
}

enum ReactionType {
  LIKE
  LOVE
  LAUGH
  WOW
  SAD
  ANGRY
}

model ProfilePost {
  id        String             @id @default(cuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      ProfilePostType
  content   String?
  linkUrl   String?
  linkTitle String?
  linkImage String?
  privacy   ProfilePostPrivacy @default(PUBLIC)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  deletedAt DateTime?

  media         ProfilePostMedia[]
  reactions     ProfilePostReaction[]
  comments      ProfilePostComment[]
  hiddenRecords ProfilePostHidden[]

  @@index([userId, createdAt])
  @@index([userId, privacy, createdAt])
}

model ProfilePostMedia {
  id         String      @id @default(cuid())
  postId     String
  post       ProfilePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  type       MediaType
  url        String
  storageKey String
  mimeType   String
  fileSize   Int
  width      Int?
  height     Int?
  duration   Int?
  order      Int         @default(0)
  createdAt  DateTime    @default(now())

  @@index([postId, order])
}

model ProfilePostReaction {
  id        String       @id @default(cuid())
  postId    String
  post      ProfilePost  @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      ReactionType @default(LIKE)
  createdAt DateTime     @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model ProfilePostComment {
  id        String      @id @default(cuid())
  postId    String
  post      ProfilePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  deletedAt DateTime?

  @@index([postId, createdAt])
  @@index([userId])
}

model ProfilePostHidden {
  id             String      @id @default(cuid())
  postId         String
  post           ProfilePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tenantId       String
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  hiddenByUserId String?
  hiddenByUser   User?       @relation(fields: [hiddenByUserId], references: [id])
  hiddenAt       DateTime    @default(now())

  @@unique([postId, tenantId])
  @@index([tenantId])
}
